# Market Data Aggregation Test Specification
# Tests the market_aggregation.sql query
#
# See: docs/feature/FR-084-app-test-harness/GETTING_STARTED.md

application: market_aggregation
description: Validates the market data aggregation query

# Default settings
default_timeout_ms: 30000
default_records: 1000

queries:
  # Test 1: Basic functionality with default record count
  - name: market_aggregates
    description: Test aggregation produces expected results
    inputs:
      - source: market_data
        records: 1000
    # New format: explicit output sink with per-sink assertions
    # Note: sink name must match the actual output topic from SQL config
    outputs:
      - sink: market_aggregates_output
        assertions:
          # Should produce output records (one per symbol)
          - type: record_count
            greater_than: 0

          # Should have all required fields
          - type: schema_contains
            fields:
              - symbol
              - trade_count
              - total_volume
              - avg_price
              - min_price
              - max_price

          # No nulls in key fields
          - type: no_nulls
            fields: [symbol, trade_count, avg_price]

          # Performance constraint
          - type: execution_time
            max_ms: 10000

  # Test 2: Higher volume test
  - name: market_aggregates_high_volume
    description: Test with higher volume to verify scalability
    inputs:
      - source: market_data
        records: 5000
    outputs:
      - sink: market_aggregates_output
        assertions:
          - type: record_count
            greater_than: 0

          # Memory shouldn't explode with more data
          - type: memory_usage
            max_mb: 200

  # Test 3: Minimal input test
  - name: market_aggregates_minimal
    description: Verify behavior with minimal input
    inputs:
      - source: market_data
        records: 10
    outputs:
      - sink: market_aggregates_output
        assertions:
          # With EMIT CHANGES mode, we may get more output records than input
          # due to intermediate window results. Just verify we got some output.
          - type: record_count
            greater_than: 0

          - type: no_nulls
            fields: [symbol, trade_count]
