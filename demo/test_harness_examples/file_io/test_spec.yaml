# File-based Trade Analysis Test
# Demonstrates CSV file input/output with SQL enrichment
# No Kafka required!

application: file_io_demo
description: Demonstrates file-based SQL processing - enriches trades with calculated fields

default_timeout_ms: 30000

queries:
  - name: enriched_trades
    description: Enriches trade data with trade_value and trade_size classification
    inputs:
      - source: trades
        source_type:
          type: file
          path: ./input_trades.csv
          format: csv
          watch: false
    output:
      sink_type:
        type: file
        path: ./output_trades.csv
        format: csv
    assertions:
      # Check the output file exists
      - type: file_exists
        path: ./output_trades.csv
        min_size_bytes: 100

      # Check row count (all 6 trades have volume >= 50)
      - type: file_row_count
        path: ./output_trades.csv
        format: csv
        equals: 6

      # Verify all symbols are present
      - type: file_contains
        path: ./output_trades.csv
        format: csv
        field: symbol
        expected_values:
          - AAPL
          - GOOGL
          - MSFT
        mode: all

      # Verify trade_size categories exist
      - type: file_contains
        path: ./output_trades.csv
        format: csv
        field: trade_size
        expected_values:
          - SMALL
          - MEDIUM
          - LARGE
        mode: all

      # Verify output matches expected (with numeric tolerance for trade_value)
      - type: file_matches
        actual_path: ./output_trades.csv
        expected_path: ./expected_output.csv
        format: csv
        ignore_order: true
        numeric_tolerance: 0.01
