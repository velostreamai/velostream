# =============================================================================
# Test: Trading Signals
# =============================================================================
# Tests volume analytics and signal generation

application: trading_signals
description: |
  Tests trading signal generation including volume spike detection.

default_timeout_ms: 60000
default_records: 1000

queries:
  # Test volume spike analysis
  - name: volume_spike_analysis
    description: Test volume spike detection with sliding window
    inputs:
      - source: market_data_ts
        records: 1000
        time_simulation:
          start_time: "-1h"
          end_time: "now"
          sequential: true
          events_per_second: 500
    outputs:
      - sink: volume_spikes
        assertions:
          - type: record_count
            greater_than: 0

          - type: schema_contains
            key_field: symbol
            fields:
              - avg_volume

          - type: no_nulls
            fields: [symbol]

          # Data accuracy: avg_volume must be positive
          - type: field_values
            field: avg_volume
            operator: greater_than
            value: 0

          # Data accuracy: trade_count must be positive
          - type: field_values
            field: trade_count
            operator: greater_than
            value: 0

          # Data accuracy: min_volume must be positive
          - type: field_values
            field: min_volume
            operator: greater_than
            value: 0

          # Data accuracy: max_volume must be positive
          - type: field_values
            field: max_volume
            operator: greater_than
            value: 0

          # Data accuracy: stddev_volume must be non-negative
          - type: field_values
            field: stddev_volume
            operator: greater_than_or_equals
            value: 0

    # Metric assertions - verify @metric SQL annotations are emitted
    # All processor types (Simple, Transactional, Adaptive) now support @metric emission
    metric_assertions:
      - type: metric_exists
        name: velo_volume_spike_analysis_total
        expected_type: counter

      - type: metric_counter
        name: velo_volume_spike_analysis_total
        operator: greater_than
        value: 0

      - type: metric_exists
        name: velo_avg_volume
        expected_type: gauge

      - type: metric_gauge
        name: velo_avg_volume
        operator: greater_than
        value: 0

  # Test order flow imbalance detection
  - name: order_flow_imbalance
    description: Test institutional trading pattern detection from order book data
    inputs:
      - source: in_order_book_stream
        records: 1000
        time_simulation:
          start_time: "-5m"
          end_time: "now"
          sequential: true
          events_per_second: 500
    outputs:
      - sink: order_imbalance
        assertions:
          - type: record_count
            greater_than: 0
          - type: schema_contains
            key_field: symbol
            fields:
              - buy_volume
              - sell_volume
              - buy_ratio

  # Test cross-exchange arbitrage detection
  - name: arbitrage_detection
    description: Test cross-exchange price discrepancy detection
    inputs:
      - source: in_market_data_stream_a
        records: 1000
        time_simulation:
          start_time: "-1h"
          end_time: "now"
          sequential: true
          events_per_second: 500
      - source: in_market_data_stream_b
        records: 1000
        time_simulation:
          start_time: "-1h"
          end_time: "now"
          sequential: true
          events_per_second: 500
    outputs:
      - sink: arbitrage_opportunities
        assertions:
          - type: record_count
            greater_than: 0
