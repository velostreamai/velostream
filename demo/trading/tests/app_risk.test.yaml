# =============================================================================
# Test: Risk Monitoring
# =============================================================================
# Tests position tracking and risk limit validation

application: risk_monitoring
description: |
  Tests real-time risk monitoring with position tracking.
  Validates cumulative P&L and exposure calculations.

default_timeout_ms: 60000
default_records: 500

queries:
  # Test trading positions with event-time processing
  - name: trading_positions_ts
    description: Test position tracking with event-time processing
    inputs:
      - source: in_trading_positions_stream
        schema: trading_positions
        records: 500
        time_simulation:
          start_time: "-1h"
          end_time: "now"
          sequential: true
          events_per_second: 250
    outputs:
      - sink: trading_positions_ts
        assertions:
          - type: record_count
            greater_than: 0

          - type: schema_contains
            key_field: position_id
            fields:
              - trader_id
              - symbol
              - position_size

          - type: no_nulls
            fields: [position_id, trader_id, symbol]

          # Data accuracy: position_size should exist (can be positive or negative)
          - type: schema_contains
            key_field: position_id
            fields:
              - position_size
              - current_pnl
              - timestamp

    # Metric assertions - verify @metric SQL annotations are emitted
    # All processor types (Simple, Transactional, Adaptive) now support @metric emission
    metric_assertions:
      - type: metric_exists
        name: velo_trading_positions_total
        expected_type: counter

      - type: metric_counter
        name: velo_trading_positions_total
        operator: greater_than
        value: 0

      - type: metric_exists
        name: velo_position_size
        expected_type: gauge
