# Financial Trading Analytics Test Specification
# Comprehensive test suite for sql/financial_trading.sql
#
# This test spec validates all 8+ streaming jobs in the trading analytics demo.
# See: docs/feature/FR-084-app-test-harness/README.md

application: financial_trading
description: Financial trading analytics - comprehensive test suite covering event-time processing, windowing, joins, and risk monitoring

default_timeout_ms: 60000
default_records: 1000

# Schema references for data generation
schemas:
  market_data: schemas/market_data.schema.yaml
  trading_positions: schemas/trading_positions.schema.yaml
  order_book: schemas/order_book.schema.yaml

queries:
  # ==========================================================================
  # Job 1: market_data_ts - Event-Time Watermark Processing
  # ==========================================================================
  - name: market_data_ts
    description: Event-time watermark processing with bounded out-of-orderness
    inputs:
      - source: in_market_data_stream
        schema: market_data
        records: 1000
    outputs:
      - sink: market_data_ts
        assertions:
          # Passthrough should preserve record count
          - type: record_count
            equals: 1000

          # All core fields should be present
          - type: schema_contains
            fields:
              - symbol
              - exchange
              - timestamp
              - _event_time
              - price
              - bid_price
              - ask_price
              - volume

          # No nulls in required fields
          - type: no_nulls
            fields: [symbol, exchange, price, timestamp]

          # Performance: sub-second processing
          - type: execution_time
            max_ms: 5000

  # ==========================================================================
  # Job 2: tick_buckets - 1-Second Tumbling Window Aggregation
  # ==========================================================================
  - name: tick_buckets
    description: 1-second tumbling window aggregation for tick data
    inputs:
      - source: market_data_ts
        from_previous: market_data_ts
    outputs:
      - sink: tick_buckets
        assertions:
          # Should produce aggregated buckets
          - type: record_count
            greater_than: 0

          # All aggregation fields present
          - type: schema_contains
            fields:
              - symbol
              - bucket_start
              - bucket_end
              - avg_price
              - min_price
              - max_price
              - total_volume
              - trade_count

          # No nulls in key fields
          - type: no_nulls
            fields: [symbol, bucket_start, bucket_end]

  # ==========================================================================
  # Job 3: enriched_market_data - Stream-Table JOIN
  # ==========================================================================
  - name: enriched_market_data
    description: Market data enriched with instrument reference data
    inputs:
      - source: market_data_ts
        from_previous: market_data_ts
      - source: instrument_reference
        data_file: data/instrument_reference.csv
    outputs:
      - sink: enriched_market_data
        assertions:
          # JOIN should produce output (may have nulls for unmatched)
          - type: record_count
            greater_than: 0

          # Original market data fields
          - type: schema_contains
            fields:
              - symbol
              - exchange
              - price
              - volume

  # ==========================================================================
  # Job 4: advanced_price_movement_alerts - Window Functions
  # ==========================================================================
  - name: advanced_price_movement_alerts
    description: Price movement detection with LAG/LEAD and ranking functions
    inputs:
      - source: market_data_ts
        from_previous: market_data_ts
    outputs:
      - sink: advanced_price_movement_alerts
        assertions:
          # Should produce output with price movements
          - type: record_count
            greater_than: 0

          # Advanced window function outputs
          - type: schema_contains
            fields:
              - symbol
              - price
              - prev_price
              - price_change_pct
              - movement_severity

  # ==========================================================================
  # Job 5: compliant_market_data - EXISTS Subquery Filtering
  # ==========================================================================
  - name: compliant_market_data
    description: Regulatory compliance filtering with EXISTS subquery
    inputs:
      - source: market_data_ts
        from_previous: market_data_ts
      - source: regulatory_watchlist
        data_file: data/regulatory_watchlist.csv
    outputs:
      - sink: compliant_market_data
        assertions:
          # Filtered output should be <= input
          - type: record_count
            greater_than: 0

          # Compliance status field added
          - type: schema_contains
            fields:
              - symbol
              - price
              - compliance_status

  # ==========================================================================
  # Job 6: active_hours_market_data - IN/NOT IN Subquery
  # ==========================================================================
  - name: active_hours_market_data
    description: Filter to active market hours using IN/NOT IN subqueries
    inputs:
      - source: market_data_ts
        from_previous: market_data_ts
      - source: instrument_schedules
        data_file: data/instrument_schedules.csv
      - source: trading_halts
        data_file: data/trading_halts.csv
    outputs:
      - sink: active_hours_market_data
        assertions:
          # Should produce records during trading hours
          - type: record_count
            greater_than: 0

          # Market session fields
          - type: schema_contains
            fields:
              - symbol
              - market_session
              - current_session

  # ==========================================================================
  # Job 7: volume_spike_analysis - Sliding Window with Resource Management
  # ==========================================================================
  - name: volume_spike_analysis
    description: Volume spike detection with circuit breaker protection
    inputs:
      - source: market_data_ts
        from_previous: market_data_ts
    outputs:
      - sink: volume_spike_analysis
        assertions:
          # Should detect volume patterns
          - type: record_count
            greater_than: 0

          # Spike analysis fields
          - type: schema_contains
            fields:
              - symbol
              - window_start
              - window_end
              - avg_volume
              - max_volume
              - spike_classification
              - circuit_state

  # ==========================================================================
  # Job 8: comprehensive_risk_monitor - Complex JOIN with Risk Classification
  # ==========================================================================
  - name: comprehensive_risk_monitor
    description: Real-time risk monitoring with position and market data JOIN
    inputs:
      - source: trading_positions_with_event_time
        schema: trading_positions
        records: 500
      - source: market_data_ts
        from_previous: market_data_ts
    outputs:
      - sink: comprehensive_risk_monitor
        assertions:
          # Risk events may be filtered by WHERE clause
          - type: record_count
            greater_than_or_equal: 0

          # Risk monitoring fields
          - type: schema_contains
            fields:
              - trader_id
              - symbol
              - position_size
              - current_pnl
              - risk_classification

  # ==========================================================================
  # Job 9: order_flow_imbalance_detection - Order Book Analysis
  # ==========================================================================
  - name: order_flow_imbalance_detection
    description: Detect institutional order flow imbalances
    inputs:
      - source: in_order_book_stream
        schema: order_book
        records: 1000
    outputs:
      - sink: order_flow_imbalance_detection
        assertions:
          # Imbalances are filtered by HAVING clause
          - type: record_count
            greater_than_or_equal: 0

          # Order flow analysis fields
          - type: schema_contains
            fields:
              - symbol
              - buy_volume
              - sell_volume
              - buy_ratio
              - sell_ratio

  # ==========================================================================
  # Job 10: arbitrage_opportunities_detection - Cross-Exchange Analysis
  # ==========================================================================
  - name: arbitrage_opportunities_detection
    description: Cross-exchange arbitrage opportunity detection
    inputs:
      - source: in_market_data_stream_a
        schema: market_data
        records: 500
      - source: in_market_data_stream_b
        schema: market_data
        records: 500
    outputs:
      - sink: arbitrage_opportunities_detection
        assertions:
          # Arbitrage opportunities are rare events
          - type: record_count
            greater_than_or_equal: 0

          # Arbitrage analysis fields
          - type: schema_contains
            fields:
              - symbol
              - exchange_a
              - exchange_b
              - spread
              - spread_bps

# Test scenarios for different data volumes
scenarios:
  # Quick smoke test
  - name: smoke_test
    description: Quick validation with minimal data
    default_records: 100
    queries: [market_data_ts, tick_buckets]

  # Standard test suite
  - name: standard
    description: Standard test with realistic data volumes
    default_records: 1000
    queries: all

  # High volume stress test
  - name: stress
    description: High volume test for performance validation
    default_records: 10000
    timeout_ms: 120000
    queries: [market_data_ts, tick_buckets, volume_spike_analysis]
