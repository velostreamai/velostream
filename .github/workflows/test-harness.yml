name: Test Harness CI

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'src/velostream/test_harness/**'
      - 'src/bin/velo-test.rs'
      - 'demo/test_harness_examples/**'
      - '.github/workflows/test-harness.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'src/velostream/test_harness/**'
      - 'src/bin/velo-test.rs'
      - 'demo/test_harness_examples/**'
      - '.github/workflows/test-harness.yml'
  workflow_dispatch:
    inputs:
      tier:
        description: 'Test tier to run (tier1, tier2, tier3, or all)'
        required: false
        default: 'tier1'

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  RUST_BACKTRACE: 1
  RUSTFLAGS: "-A dead_code -A unused"
  # P1.2: Topic naming placeholders for CI/CD isolation
  GITHUB_REF_NAME: ${{ github.ref_name }}
  GITHUB_ACTOR: ${{ github.actor }}
  VELOSTREAM_TEST_CONTAINER: redpanda

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ==========================================================================
  # Stage 1: Unit Tests (Fast Feedback)
  # ==========================================================================
  unit-tests:
    name: Test Harness Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup protobuf compiler
      uses: ./.github/actions/setup-protobuf

    - name: Setup Rust Environment
      uses: ./.github/actions/setup-rust
      with:
        rust-version: 1.91.0
        components: rustfmt,clippy
        cache-suffix: test-harness-unit

    - name: Run test harness unit tests
      run: |
        echo "ğŸ§ª Running test harness unit tests..."
        cargo test --lib --no-default-features test_harness:: -- --nocapture 2>&1 | tee unit_results.txt

        # Extract test counts
        PASSED=$(grep -oE "[0-9]+ passed" unit_results.txt | grep -oE "[0-9]+" | head -1 || echo "0")
        FAILED=$(grep -oE "[0-9]+ failed" unit_results.txt | grep -oE "[0-9]+" | head -1 || echo "0")

        echo "passed=${PASSED}" >> $GITHUB_OUTPUT
        echo "failed=${FAILED}" >> $GITHUB_OUTPUT

        if [ "$FAILED" != "0" ]; then
          echo "âŒ ${FAILED} tests failed"
          exit 1
        fi

        echo "âœ… All ${PASSED} unit tests passed"

    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-harness-unit-results
        path: unit_results.txt
        retention-days: 7

  # ==========================================================================
  # Stage 2: Build velo-test Binary
  # ==========================================================================
  build-binary:
    name: Build velo-test Binary
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [unit-tests]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup protobuf compiler
      uses: ./.github/actions/setup-protobuf

    - name: Setup Rust Environment
      uses: ./.github/actions/setup-rust
      with:
        rust-version: 1.91.0
        components: rustfmt,clippy
        cache-suffix: test-harness-binary

    - name: Build velo-test binary
      run: |
        echo "ğŸ—ï¸ Building velo-test binary..."
        cargo build --release --bin velo-test --no-default-features
        echo "âœ… velo-test binary built successfully"
        ls -la target/release/velo-test

    - name: Upload velo-test binary
      uses: actions/upload-artifact@v4
      with:
        name: velo-test-binary
        path: target/release/velo-test
        retention-days: 1

  # ==========================================================================
  # Stage 3: Integration Tests with Redpanda
  # ==========================================================================
  integration-tests:
    name: Test Harness Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build-binary]

    services:
      redpanda:
        image: redpandadata/redpanda:v23.3.5
        ports:
          - 9092:9092
        options: >-
          --health-cmd "rpk cluster info"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup protobuf compiler
      uses: ./.github/actions/setup-protobuf

    - name: Setup Rust Environment
      uses: ./.github/actions/setup-rust
      with:
        rust-version: 1.91.0
        components: rustfmt,clippy
        cache-suffix: test-harness-integration

    - name: Download velo-test binary
      uses: actions/download-artifact@v4
      with:
        name: velo-test-binary
        path: ./bin

    - name: Setup velo-test
      run: |
        chmod +x ./bin/velo-test
        ./bin/velo-test --version || echo "Binary ready"

    - name: Wait for Redpanda
      run: |
        echo "Waiting for Redpanda..."
        timeout 60 bash -c 'until nc -z localhost 9092; do sleep 2; done'
        echo "âœ… Redpanda ready"

    - name: Validate example SQL files
      run: |
        echo "ğŸ” Validating SQL files..."
        for sql_file in demo/test_harness_examples/*/sql/*.sql; do
          if [ -f "$sql_file" ]; then
            echo "Validating: $sql_file"
            ./bin/velo-test validate "$sql_file" || echo "âš ï¸ Validation warning for $sql_file"
          fi
        done
        echo "âœ… SQL validation complete"

    - name: Run tier1 tests (basic functionality)
      if: github.event.inputs.tier == '' || github.event.inputs.tier == 'tier1' || github.event.inputs.tier == 'all'
      run: |
        echo "ğŸ§ª Running tier1 tests (basic functionality)..."

        # Find tier1 test directories
        for tier1_dir in demo/test_harness_examples/tier1_*/; do
          if [ -d "$tier1_dir" ]; then
            echo "Running tests in: $tier1_dir"
            cd "$tier1_dir"

            # Find SQL and spec files
            SQL_FILE=$(find sql -name "*.sql" | head -1)
            SPEC_FILE=$(find . -name "test_spec.yaml" -o -name "*_spec.yaml" | head -1)

            if [ -f "$SQL_FILE" ] && [ -f "$SPEC_FILE" ]; then
              echo "  SQL: $SQL_FILE"
              echo "  Spec: $SPEC_FILE"
              timeout 120 ../../bin/velo-test run "$SQL_FILE" --spec "$SPEC_FILE" \
                --timeout-ms 60000 --output json 2>&1 | tee results.json || {
                echo "âš ï¸ Test returned non-zero exit code"
              }
            else
              echo "  Skipping: Missing SQL or spec file"
            fi

            cd ../..
          fi
        done

        echo "âœ… Tier1 tests complete"
      env:
        VELOSTREAM_KAFKA_BROKERS: localhost:9092

    - name: Run tier2 tests (windowing)
      if: github.event.inputs.tier == 'tier2' || github.event.inputs.tier == 'all'
      run: |
        echo "ğŸ§ª Running tier2 tests (windowing)..."

        for tier2_dir in demo/test_harness_examples/tier2_*/; do
          if [ -d "$tier2_dir" ]; then
            echo "Running tests in: $tier2_dir"
            cd "$tier2_dir"

            SQL_FILE=$(find sql -name "*.sql" | head -1)
            SPEC_FILE=$(find . -name "test_spec.yaml" -o -name "*_spec.yaml" | head -1)

            if [ -f "$SQL_FILE" ] && [ -f "$SPEC_FILE" ]; then
              timeout 180 ../../bin/velo-test run "$SQL_FILE" --spec "$SPEC_FILE" \
                --timeout-ms 90000 --output json 2>&1 | tee results.json || {
                echo "âš ï¸ Test returned non-zero exit code"
              }
            fi

            cd ../..
          fi
        done

        echo "âœ… Tier2 tests complete"
      env:
        VELOSTREAM_KAFKA_BROKERS: localhost:9092

    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-harness-integration-results
        path: |
          demo/test_harness_examples/**/results.json
        retention-days: 7

  # ==========================================================================
  # Report Results to PR
  # ==========================================================================
  report-results:
    name: Report Test Harness Results
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [unit-tests, integration-tests]
    if: always() && github.event_name == 'pull_request'

    steps:
    - name: Comment Test Results
      uses: actions/github-script@v7
      with:
        script: |
          const unitStatus = '${{ needs.unit-tests.result }}';
          const integrationStatus = '${{ needs.integration-tests.result }}';

          const getEmoji = (status) => {
            switch(status) {
              case 'success': return 'âœ…';
              case 'failure': return 'âŒ';
              case 'cancelled': return 'âšª';
              default: return 'âš ï¸';
            }
          };

          const allPassed = unitStatus === 'success' && integrationStatus === 'success';

          const comment = `## ğŸ§ª Test Harness CI Results

          ### Stage Results
          | Stage | Status |
          |-------|--------|
          | Unit Tests | ${getEmoji(unitStatus)} ${unitStatus} |
          | Integration Tests | ${getEmoji(integrationStatus)} ${integrationStatus} |

          ### Topic Naming (P1.2)
          - **Branch**: \`${process.env.GITHUB_REF_NAME || 'unknown'}\`
          - **Actor**: \`${process.env.GITHUB_ACTOR || 'unknown'}\`
          - **Isolation Pattern**: \`test_{branch}_{run_id}_{base}\`

          ${allPassed ?
            'âœ… **All test harness checks passed!** Ready for merge.' :
            'ğŸš¨ **Action Required**: Some tests failed. Review the [workflow logs](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId + ') for details.'}
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
