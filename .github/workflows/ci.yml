name: Main Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  RUST_BACKTRACE: 1
  RUSTFLAGS: "-A dead_code -A unused"

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  # Fast feedback - runs first, completes in ~3-5 minutes
  quick-check:
    name: Quick Check
    runs-on: ubuntu-latest
    outputs:
      test-results: ${{ steps.test-results.outputs.results }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup protobuf compiler
      uses: ./.github/actions/setup-protobuf

    - name: Setup Rust Environment
      uses: ./.github/actions/setup-rust
      with:
        rust-version: 1.91.0
        components: rustfmt,clippy
        cache-suffix: quick

    - name: Check formatting
      run: cargo fmt --all -- --check

    - name: Check compilation
      run: cargo check --all-targets --no-default-features

    - name: Run clippy
      run: cargo clippy --all-targets --no-default-features

    - name: Run unit tests
      id: unit-tests
      run: |
        cargo test --lib --no-default-features --quiet > test_results.txt 2>&1 || {
          echo "‚ùå Unit tests failed"
          cat test_results.txt
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        }

        # Extract test results using awk for precise parsing
        TEST_RESULT_LINE=$(grep -E "test result:.*(ok|FAILED)" test_results.txt | tail -1)
        PASSED=$(echo "$TEST_RESULT_LINE" | awk '{for(i=1;i<=NF;i++) if($i~/^[0-9]+$/ && $(i+1)=="passed" || $(i+1)=="passed;") print $i}' || echo "0")
        FAILED=$(echo "$TEST_RESULT_LINE" | awk '{for(i=1;i<=NF;i++) if($i~/^[0-9]+$/ && ($(i+1)=="failed" || $(i+1)=="failed;")) print $i}' || echo "0")

        # Handle case where no failures (0 failed might not appear)
        if [[ -z "$FAILED" ]]; then
          FAILED="0"
        fi
        if [[ -z "$PASSED" ]]; then
          PASSED="0"
        fi

        # Debug output
        echo "Debug: Test results parsing"
        echo "Raw output (last 10 lines):"
        tail -10 test_results.txt
        echo "Test result line: $TEST_RESULT_LINE"
        echo "Awk debug - looking for word 'passed' after numbers:"
        echo "$TEST_RESULT_LINE" | awk '{for(i=1;i<=NF;i++) if($i~/^[0-9]+$/) print "Found number:", $i, "followed by:", $(i+1)}'
        echo "Parsed PASSED: $PASSED"
        echo "Parsed FAILED: $FAILED"

        echo "status=passed" >> $GITHUB_OUTPUT
        echo "passed=${PASSED}" >> $GITHUB_OUTPUT
        echo "failed=${FAILED}" >> $GITHUB_OUTPUT
        echo "‚úÖ Unit tests passed: ${PASSED} passed, ${FAILED} failed"

    - name: Test examples compile
      run: |
        cargo check --example builder_configuration --no-default-features
        cargo check --example consumer_with_headers --no-default-features
        cargo check --example fluent_api_example --no-default-features
        cargo check --example json_performance_test --no-default-features

    - name: Set test results output
      id: test-results
      run: |
        echo "results={\"status\":\"${{ steps.unit-tests.outputs.status }}\",\"passed\":\"${{ steps.unit-tests.outputs.passed }}\",\"failed\":\"${{ steps.unit-tests.outputs.failed }}\"}" >> $GITHUB_OUTPUT

  # Comprehensive tests - only run after quick-check passes
  comprehensive-tests:
    name: Comprehensive Tests
    runs-on: ubuntu-latest
    needs: quick-check
    if: needs.quick-check.result == 'success'
    outputs:
      test-results: ${{ steps.comprehensive-results.outputs.results }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup protobuf compiler
      uses: ./.github/actions/setup-protobuf

    - name: Setup Rust Environment
      uses: ./.github/actions/setup-rust
      with:
        rust-version: 1.91.0
        components: rustfmt,clippy
        cache-suffix: comprehensive

    - name: Run comprehensive tests
      id: comprehensive-tests
      run: |
        # Run all tests excluding performance and integration
        echo "Running comprehensive test suite..."
        cargo test --tests --no-default-features -- --skip integration:: --skip performance:: > comprehensive_results.txt 2>&1 || {
          echo "‚ùå Comprehensive tests failed"
          cat comprehensive_results.txt
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        }

        # Extract results using awk for precise parsing
        TEST_RESULT_LINE=$(grep -E "test result:.*(ok|FAILED)" comprehensive_results.txt | tail -1)
        PASSED=$(echo "$TEST_RESULT_LINE" | awk '{for(i=1;i<=NF;i++) if($i~/^[0-9]+$/ && ($(i+1)=="passed" || $(i+1)=="passed;")) print $i}' || echo "0")
        FAILED=$(echo "$TEST_RESULT_LINE" | awk '{for(i=1;i<=NF;i++) if($i~/^[0-9]+$/ && ($(i+1)=="failed" || $(i+1)=="failed;")) print $i}' || echo "0")

        # Handle case where no failures (0 failed might not appear)
        if [[ -z "$FAILED" ]]; then
          FAILED="0"
        fi
        if [[ -z "$PASSED" ]]; then
          PASSED="0"
        fi

        # Debug output
        echo "Debug: Comprehensive test results parsing"
        echo "Raw output (last 10 lines):"
        tail -10 comprehensive_results.txt
        echo "Test result line: $TEST_RESULT_LINE"
        echo "Awk debug - looking for word 'passed' after numbers:"
        echo "$TEST_RESULT_LINE" | awk '{for(i=1;i<=NF;i++) if($i~/^[0-9]+$/) print "Found number:", $i, "followed by:", $(i+1)}'
        echo "Parsed PASSED: $PASSED"
        echo "Parsed FAILED: $FAILED"

        echo "status=passed" >> $GITHUB_OUTPUT
        echo "passed=${PASSED}" >> $GITHUB_OUTPUT
        echo "failed=${FAILED}" >> $GITHUB_OUTPUT
        echo "‚úÖ Comprehensive tests passed: ${PASSED} passed, ${FAILED} failed"

    - name: Run doctests
      run: cargo test --doc --no-default-features --quiet

    - name: Set comprehensive results output
      id: comprehensive-results
      run: |
        echo "results={\"status\":\"${{ steps.comprehensive-tests.outputs.status }}\",\"passed\":\"${{ steps.comprehensive-tests.outputs.passed }}\",\"failed\":\"${{ steps.comprehensive-tests.outputs.failed }}\"}" >> $GITHUB_OUTPUT

  # Report test results to PR
  report-test-results:
    name: Report Test Results
    runs-on: ubuntu-latest
    needs: [quick-check, comprehensive-tests]
    if: always() && github.event_name == 'pull_request'

    steps:
    - name: Comment Test Results
      uses: actions/github-script@v7
      with:
        script: |
          // Parse JSON strings from workflow outputs
          let quickCheck;
          let comprehensive;

          try {
            quickCheck = JSON.parse('${{ needs.quick-check.outputs.test-results }}');
          } catch (e) {
            quickCheck = {status: "failed", passed: "0", failed: "1"};
          }

          try {
            comprehensive = JSON.parse('${{ needs.comprehensive-tests.outputs.test-results }}');
          } catch (e) {
            comprehensive = {status: "failed", passed: "0", failed: "1"};
          }

          const quickStatus = quickCheck.status === 'passed' ? '‚úÖ' : '‚ùå';
          const comprehensiveStatus = comprehensive.status === 'passed' ? '‚úÖ' : '‚ùå';

          const comment = `## üß™ Main Pipeline Results

          ### Quick Check Tests ${quickStatus}
          - **Unit Tests**: ${quickCheck.passed} passed, ${quickCheck.failed} failed
          - **Status**: ${quickCheck.status === 'passed' ? '‚úÖ All checks passed' : '‚ùå Some checks failed'}

          ### Comprehensive Tests ${comprehensiveStatus}
          - **Full Suite**: ${comprehensive.passed} passed, ${comprehensive.failed} failed
          - **Status**: ${comprehensive.status === 'passed' ? '‚úÖ All tests passed' : '‚ùå Some tests failed'}

          ### Summary
          ${quickCheck.status === 'passed' && comprehensive.status === 'passed' ?
            '‚úÖ **All tests passing** - Ready for review!' :
            '‚ùå **Tests failed** - Please check the workflow run for details'}

          View detailed results in the [workflow run](${context.payload.pull_request.html_url}/checks).`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });